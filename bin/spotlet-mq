#!/usr/bin/env node

/**
 * Module dependencies
 */

var mq = require('../')
  , path = require('path')
  , debug = require('debug')('spotlet-mq')

var PORT = process.env.PORT || 9346;
var server = null;
var REALMS = null;

REALMS = process.env.REALMS || void function() {
  throw new Error("Environment variable `REALMS' undefined");
}();

server = mq.createCommandServer(oncommand).listen(PORT);

debug("listening on port `%d'", PORT);
function oncommand (cmd) {
  debug("command received %j", cmd);
  var realm = null;
  try {
    realm = require(path.resolve(REALMS, cmd.realm));

    if ('function' == typeof realm) {
      debug("entering realm `%s'", cmd.realm);
      realm(cmd.args, server.socket);
    }
  } catch (e) {
    console.error("error: Unknown realm %s", cmd.realm);
  }
}

